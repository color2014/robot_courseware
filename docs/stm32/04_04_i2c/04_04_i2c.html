



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="传智专修学院 人工智能和机器人实验室 正则表达式">
      
      
        <link rel="canonical" href="https://www.czxy.com/docs/04_04_i2c/">
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>I2C通讯 - 黑马机器人—STM32！</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#i2c" tabindex="0" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <!-- <a href="https://www.czxy.com/docs" title="黑马机器人—STM32！" aria-label="黑马机器人—STM32！" class="md-header-nav__button md-logo"> -->
        <a href="/" title="黑马机器人—STM32！" aria-label="黑马机器人—STM32！" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              <a href="https://www.czxy.com/docs">黑马机器人—STM32！</a>
            </span>
            <span class="md-header-nav__topic">
              
                I2C通讯
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer" style="display: none;">
    <a href="https://www.czxy.com/docs" title="黑马机器人—STM32！" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    黑马机器人—STM32！
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../00_intro/" title="课程介绍" class="md-nav__link">
      课程介绍
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01_env/" title="环境搭建" class="md-nav__link">
      环境搭建
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01_stm32_quickstart/" title="快速入门" class="md-nav__link">
      快速入门
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02_motor/" title="驱动电机" class="md-nav__link">
      驱动电机
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../03_diff_2wd_driver/" title="差速运动" class="md-nav__link">
      差速运动
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../04_01_oled/" title="OLED显示" class="md-nav__link">
      OLED显示
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../04_02_ps2/" title="PS2控制" class="md-nav__link">
      PS2控制
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../04_03_blueth/" title="蓝牙控制" class="md-nav__link">
      蓝牙控制
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        I2C通讯
      </label>
    
    <a href="./" title="I2C通讯" class="md-nav__link md-nav__link--active">
      I2C通讯
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mpu9250h" class="md-nav__link">
    导入mpu9250.h
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mpu9250cpp" class="md-nav__link">
    导入mpu9250.cpp
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../05_custom_serial/" title="串口通讯" class="md-nav__link">
      串口通讯
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mpu9250h" class="md-nav__link">
    导入mpu9250.h
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mpu9250cpp" class="md-nav__link">
    导入mpu9250.cpp
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="i2c">I2C通讯<a class="headerlink" href="#i2c" title="Permanent link">&para;</a></h1>
<p>I2C总线是由<a href="https://baike.baidu.com/item/Philips">Philips</a>公司开发的一种简单、双向二线制同步串行总线。它只需要两根线即可在连接于总线上的器件之间传送信息。</p>
<p>主器件用于启动总线传送数据，并产生时钟以开放传送的器件，此时任何被寻址的器件均被认为是从器件．在总线上主和从、发和收的关系不是恒定的，而取决于此时数据传送方向。如果主机要发送数据给从器件，则主机首先寻址从器件，然后主动发送数据至从器件，最后由主机终止数据传送；如果主机要接收从器件的数据，首先由主器件寻址从器件．然后主机接收从器件发送的数据，最后由主机终止接收过程。在这种情况下．主机负责产生定时时钟和终止数据传送。 </p>
<p><img alt="" src="../img/env24.jpg" /></p>
<p>举个简单的例子来理解I2C通讯的话, 我们可以理解为有这么个便民数据中心, 所有的居民都通过一条叫做世纪大道的路连接到便民中心. 每家每户都有自己的门牌号, 每一户的房间都有编号.</p>
<p>现在便民中心的人员, 想去小明家拿个大铁锅, 那他需要知道小明家的门牌号,还需要知道锅在哪个房间. </p>
<p>对于I2C通讯来说,就是我们需要知道小明家的地址0x66,然后大铁锅所在的厨房0x33就可以了!  I2C通讯的好处就是只需要一条总线就可以与很多元器件进行通讯,这个非常适合短距离通讯.</p>
<p>当前我们的PCB电路板上有一个MPU9250的九轴传感器.分别可以获取:</p>
<ol>
<li>x,y,z方向的加速度数据</li>
<li>x,y,z三轴的角速度</li>
<li>x,y,z三轴的地磁数据</li>
</ol>
<p>我们要从它里面获取数据,我们只需要设置CubeMX的<strong>I2C1</strong>功能即可</p>
<p><img alt="" src="../img/env25.jpg" /></p>
<h2 id="mpu9250h">导入mpu9250.h<a class="headerlink" href="#mpu9250h" title="Permanent link">&para;</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="cp">#ifndef ZXCAR_ZET6_MPU9250_H</span>
<span class="cp">#define ZXCAR_ZET6_MPU9250_H</span>

<span class="cp">#ifndef _MPU9250_H</span>
<span class="cp">#define _MPU9250_H</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>

<span class="c1">//////////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">//如果AD0脚(9脚)接地,IIC地址为0X68(不包含最低位).</span>
<span class="c1">//如果接V3.3,则IIC地址为0X69(不包含最低位).</span>
<span class="cp">#define MPU9250_ADDR            0X68    </span><span class="c1">//MPU9250的器件IIC地址</span>
<span class="cp">#define MPU6500_ID              0X71    </span><span class="c1">//MPU6500的器件ID</span>

<span class="c1">//MPU9250内部封装了一个AK8963磁力计,地址和ID如下:</span>
<span class="cp">#define AK8963_ADDR             0X0C    </span><span class="c1">//AK8963的I2C地址</span>
<span class="cp">#define AK8963_ID               0X48    </span><span class="c1">//AK8963的器件ID</span>


<span class="c1">//AK8963的内部寄存器</span>
<span class="cp">#define MAG_WIA                 0x00    </span><span class="c1">//AK8963的器件ID寄存器地址</span>
<span class="cp">#define MAG_CNTL1               0X0A</span>
<span class="cp">#define MAG_CNTL2               0X0B</span>

<span class="cp">#define MAG_XOUT_L              0X03</span>
<span class="cp">#define MAG_XOUT_H              0X04</span>
<span class="cp">#define MAG_YOUT_L              0X05</span>
<span class="cp">#define MAG_YOUT_H              0X06</span>
<span class="cp">#define MAG_ZOUT_L              0X07</span>
<span class="cp">#define MAG_ZOUT_H              0X08</span>

<span class="c1">//MPU6500的内部寄存器</span>
<span class="cp">#define MPU_SELF_TESTX_REG      0X0D    </span><span class="c1">//自检寄存器X</span>
<span class="cp">#define MPU_SELF_TESTY_REG      0X0E    </span><span class="c1">//自检寄存器Y</span>
<span class="cp">#define MPU_SELF_TESTZ_REG      0X0F    </span><span class="c1">//自检寄存器Z</span>
<span class="cp">#define MPU_SELF_TESTA_REG      0X10    </span><span class="c1">//自检寄存器A</span>
<span class="cp">#define MPU_SAMPLE_RATE_REG     0X19    </span><span class="c1">//采样频率分频器</span>
<span class="cp">#define MPU_CFG_REG             0X1A    </span><span class="c1">//配置寄存器</span>
<span class="cp">#define MPU_GYRO_CFG_REG        0X1B    </span><span class="c1">//陀螺仪配置寄存器</span>
<span class="cp">#define MPU_ACCEL_CFG_REG       0X1C    </span><span class="c1">//加速度计配置寄存器</span>
<span class="cp">#define MPU_MOTION_DET_REG      0X1F    </span><span class="c1">//运动检测阀值设置寄存器</span>
<span class="cp">#define MPU_FIFO_EN_REG         0X23    </span><span class="c1">//FIFO使能寄存器</span>
<span class="cp">#define MPU_I2CMST_CTRL_REG     0X24    </span><span class="c1">//IIC主机控制寄存器</span>
<span class="cp">#define MPU_I2CSLV0_ADDR_REG    0X25    </span><span class="c1">//IIC从机0器件地址寄存器</span>
<span class="cp">#define MPU_I2CSLV0_REG         0X26    </span><span class="c1">//IIC从机0数据地址寄存器</span>
<span class="cp">#define MPU_I2CSLV0_CTRL_REG    0X27    </span><span class="c1">//IIC从机0控制寄存器</span>
<span class="cp">#define MPU_I2CSLV1_ADDR_REG    0X28    </span><span class="c1">//IIC从机1器件地址寄存器</span>
<span class="cp">#define MPU_I2CSLV1_REG         0X29    </span><span class="c1">//IIC从机1数据地址寄存器</span>
<span class="cp">#define MPU_I2CSLV1_CTRL_REG    0X2A    </span><span class="c1">//IIC从机1控制寄存器</span>
<span class="cp">#define MPU_I2CSLV2_ADDR_REG    0X2B    </span><span class="c1">//IIC从机2器件地址寄存器</span>
<span class="cp">#define MPU_I2CSLV2_REG         0X2C    </span><span class="c1">//IIC从机2数据地址寄存器</span>
<span class="cp">#define MPU_I2CSLV2_CTRL_REG    0X2D    </span><span class="c1">//IIC从机2控制寄存器</span>
<span class="cp">#define MPU_I2CSLV3_ADDR_REG    0X2E    </span><span class="c1">//IIC从机3器件地址寄存器</span>
<span class="cp">#define MPU_I2CSLV3_REG         0X2F    </span><span class="c1">//IIC从机3数据地址寄存器</span>
<span class="cp">#define MPU_I2CSLV3_CTRL_REG    0X30    </span><span class="c1">//IIC从机3控制寄存器</span>
<span class="cp">#define MPU_I2CSLV4_ADDR_REG    0X31    </span><span class="c1">//IIC从机4器件地址寄存器</span>
<span class="cp">#define MPU_I2CSLV4_REG         0X32    </span><span class="c1">//IIC从机4数据地址寄存器</span>
<span class="cp">#define MPU_I2CSLV4_DO_REG      0X33    </span><span class="c1">//IIC从机4写数据寄存器</span>
<span class="cp">#define MPU_I2CSLV4_CTRL_REG    0X34    </span><span class="c1">//IIC从机4控制寄存器</span>
<span class="cp">#define MPU_I2CSLV4_DI_REG      0X35    </span><span class="c1">//IIC从机4读数据寄存器</span>

<span class="cp">#define MPU_I2CMST_STA_REG      0X36    </span><span class="c1">//IIC主机状态寄存器</span>
<span class="cp">#define MPU_INTBP_CFG_REG       0X37    </span><span class="c1">//中断/旁路设置寄存器</span>
<span class="cp">#define MPU_INT_EN_REG          0X38    </span><span class="c1">//中断使能寄存器</span>
<span class="cp">#define MPU_INT_STA_REG         0X3A    </span><span class="c1">//中断状态寄存器</span>

<span class="cp">#define MPU_ACCEL_XOUTH_REG     0X3B    </span><span class="c1">//加速度值,X轴高8位寄存器</span>
<span class="cp">#define MPU_ACCEL_XOUTL_REG     0X3C    </span><span class="c1">//加速度值,X轴低8位寄存器</span>
<span class="cp">#define MPU_ACCEL_YOUTH_REG     0X3D    </span><span class="c1">//加速度值,Y轴高8位寄存器</span>
<span class="cp">#define MPU_ACCEL_YOUTL_REG     0X3E    </span><span class="c1">//加速度值,Y轴低8位寄存器</span>
<span class="cp">#define MPU_ACCEL_ZOUTH_REG     0X3F    </span><span class="c1">//加速度值,Z轴高8位寄存器</span>
<span class="cp">#define MPU_ACCEL_ZOUTL_REG     0X40    </span><span class="c1">//加速度值,Z轴低8位寄存器</span>

<span class="cp">#define MPU_TEMP_OUTH_REG       0X41    </span><span class="c1">//温度值高八位寄存器</span>
<span class="cp">#define MPU_TEMP_OUTL_REG       0X42    </span><span class="c1">//温度值低8位寄存器</span>

<span class="cp">#define MPU_GYRO_XOUTH_REG      0X43    </span><span class="c1">//陀螺仪值,X轴高8位寄存器</span>
<span class="cp">#define MPU_GYRO_XOUTL_REG      0X44    </span><span class="c1">//陀螺仪值,X轴低8位寄存器</span>
<span class="cp">#define MPU_GYRO_YOUTH_REG      0X45    </span><span class="c1">//陀螺仪值,Y轴高8位寄存器</span>
<span class="cp">#define MPU_GYRO_YOUTL_REG      0X46    </span><span class="c1">//陀螺仪值,Y轴低8位寄存器</span>
<span class="cp">#define MPU_GYRO_ZOUTH_REG      0X47    </span><span class="c1">//陀螺仪值,Z轴高8位寄存器</span>
<span class="cp">#define MPU_GYRO_ZOUTL_REG      0X48    </span><span class="c1">//陀螺仪值,Z轴低8位寄存器</span>

<span class="cp">#define MPU_I2CSLV0_DO_REG      0X63    </span><span class="c1">//IIC从机0数据寄存器</span>
<span class="cp">#define MPU_I2CSLV1_DO_REG      0X64    </span><span class="c1">//IIC从机1数据寄存器</span>
<span class="cp">#define MPU_I2CSLV2_DO_REG      0X65    </span><span class="c1">//IIC从机2数据寄存器</span>
<span class="cp">#define MPU_I2CSLV3_DO_REG      0X66    </span><span class="c1">//IIC从机3数据寄存器</span>

<span class="cp">#define MPU_I2CMST_DELAY_REG    0X67    </span><span class="c1">//IIC主机延时管理寄存器</span>
<span class="cp">#define MPU_SIGPATH_RST_REG     0X68    </span><span class="c1">//信号通道复位寄存器</span>
<span class="cp">#define MPU_MDETECT_CTRL_REG    0X69    </span><span class="c1">//运动检测控制寄存器</span>
<span class="cp">#define MPU_USER_CTRL_REG       0X6A    </span><span class="c1">//用户控制寄存器</span>
<span class="cp">#define MPU_PWR_MGMT1_REG       0X6B    </span><span class="c1">//电源管理寄存器1</span>
<span class="cp">#define MPU_PWR_MGMT2_REG       0X6C    </span><span class="c1">//电源管理寄存器2</span>
<span class="cp">#define MPU_FIFO_CNTH_REG       0X72    </span><span class="c1">//FIFO计数寄存器高八位</span>
<span class="cp">#define MPU_FIFO_CNTL_REG       0X73    </span><span class="c1">//FIFO计数寄存器低八位</span>
<span class="cp">#define MPU_FIFO_RW_REG         0X74    </span><span class="c1">//FIFO读写寄存器</span>
<span class="cp">#define MPU_DEVICE_ID_REG       0X75    </span><span class="c1">//器件ID寄存器</span>

<span class="cp">#define u8 uint8_t</span>
<span class="cp">#define u16 uint16_t</span>


<span class="kt">void</span> <span class="nf">Read_DMP</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU9250_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_WaitForReady</span><span class="p">(</span><span class="n">u8</span> <span class="n">devaddr</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Write_Byte</span><span class="p">(</span><span class="n">u8</span> <span class="n">devaddr</span><span class="p">,</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span><span class="n">u8</span> <span class="n">data</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Read_Byte</span><span class="p">(</span><span class="n">u8</span> <span class="n">devaddr</span><span class="p">,</span><span class="n">u8</span> <span class="n">reg</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Set_Gyro_Fsr</span><span class="p">(</span><span class="n">u8</span> <span class="n">fsr</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Set_Accel_Fsr</span><span class="p">(</span><span class="n">u8</span> <span class="n">fsr</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Set_Rate</span><span class="p">(</span><span class="n">u16</span> <span class="n">rate</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Write_Len</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">,</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span><span class="n">u8</span> <span class="n">len</span><span class="p">,</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Read_Len</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">,</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span><span class="n">u8</span> <span class="n">len</span><span class="p">,</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="kt">short</span> <span class="nf">MPU_Get_Temperature</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Get_Gyroscope</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="n">gx</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">gy</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">gz</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Get_Accelerometer</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="n">ax</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">ay</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">az</span><span class="p">);</span>
<span class="n">u8</span> <span class="nf">MPU_Get_Magnetometer</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="n">mx</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">my</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">mz</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="c1">//ZXCAR_ZET6_MPU9250_H</span>
</code></pre></div>
</td></tr></table>

<h2 id="mpu9250cpp">导入mpu9250.cpp<a class="headerlink" href="#mpu9250cpp" title="Permanent link">&para;</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;MPU9250.h&quot;</span><span class="cp"></span>
<span class="c1">//#include &quot;mpu9250.h&quot;</span>
<span class="cp">#include</span> <span class="cpf">&quot;i2c.h&quot;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">Read_DMP</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * MPU_Get_Accelerometer(&amp;aacx,&amp;aacy,&amp;aacz);    //得到加速度传感器数据</span>
<span class="cm">     ACCEL_X=aacx/164;ACCEL_Y=aacy/164;ACCEL_Z=aacz/(-164);</span>
<span class="cm">     MPU_Get_Gyroscope(&amp;gyrox,&amp;gyroy,&amp;gyroz);   //得到陀螺仪数据</span>
<span class="cm">   GYRO_X=gyrox/(-16.4);GYRO_Y=gyroy/16.4;GYRO_Z=gyroz/(-16.4);</span>
<span class="cm"> * */</span>
<span class="p">}</span>
<span class="c1">//初始化MPU9250</span>
<span class="c1">//返回值:0,成功</span>
<span class="c1">//    其他,错误代码</span>
<span class="n">u8</span> <span class="nf">MPU9250_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">res</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="c1">//IIC_Init();     //初始化IIC总线</span>
    <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_PWR_MGMT1_REG</span><span class="p">,</span><span class="mi">0</span><span class="n">X80</span><span class="p">);</span><span class="c1">//复位MPU9250</span>

    <span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>  <span class="c1">//延时100ms</span>
    <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_PWR_MGMT1_REG</span><span class="p">,</span><span class="mi">0</span><span class="n">X00</span><span class="p">);</span><span class="c1">//唤醒MPU9250</span>

    <span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>  <span class="c1">//延时100ms</span>
    <span class="n">MPU_Set_Gyro_Fsr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>                                <span class="c1">//陀螺仪传感器,±2000dps</span>
    <span class="n">MPU_Set_Accel_Fsr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>                               <span class="c1">//加速度传感器,±2g</span>
    <span class="n">MPU_Set_Rate</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>                                   <span class="c1">//设置采样率50Hz</span>

    <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_INT_EN_REG</span><span class="p">,</span><span class="mi">0</span><span class="n">X00</span><span class="p">);</span>   <span class="c1">//关闭所有中断</span>
    <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_USER_CTRL_REG</span><span class="p">,</span><span class="mi">0</span><span class="n">X00</span><span class="p">);</span><span class="c1">//I2C主模式关闭</span>
    <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_FIFO_EN_REG</span><span class="p">,</span><span class="mi">0</span><span class="n">X00</span><span class="p">);</span>  <span class="c1">//关闭FIFO</span>
    <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_INTBP_CFG_REG</span><span class="p">,</span><span class="mi">0</span><span class="n">X82</span><span class="p">);</span><span class="c1">//INT引脚低电平有效，开启bypass模式，可以直接读取磁力计</span>
    <span class="n">res</span><span class="o">=</span><span class="n">MPU_Read_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_DEVICE_ID_REG</span><span class="p">);</span>  <span class="c1">//读取MPU6500的ID</span>
    <span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="o">==</span><span class="n">MPU6500_ID</span><span class="p">)</span> <span class="c1">//器件ID正确</span>
    <span class="p">{</span>
        <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_PWR_MGMT1_REG</span><span class="p">,</span><span class="mi">0</span><span class="n">X01</span><span class="p">);</span>    <span class="c1">//设置CLKSEL,PLL X轴为参考</span>
        <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_PWR_MGMT2_REG</span><span class="p">,</span><span class="mi">0</span><span class="n">X00</span><span class="p">);</span>    <span class="c1">//加速度与陀螺仪都工作</span>
        <span class="n">MPU_Set_Rate</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>                               <span class="c1">//设置采样率为50Hz</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">res</span><span class="o">=</span><span class="n">MPU_Read_Byte</span><span class="p">(</span><span class="n">AK8963_ADDR</span><span class="p">,</span><span class="n">MAG_WIA</span><span class="p">);</span>             <span class="c1">//读取AK8963 ID</span>
    <span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="o">==</span><span class="n">AK8963_ID</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">AK8963_ADDR</span><span class="p">,</span><span class="n">MAG_CNTL1</span><span class="p">,</span><span class="mi">0</span><span class="n">X11</span><span class="p">);</span>     <span class="c1">//设置AK8963为单次测量模式</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//设置MPU9250陀螺仪传感器满量程范围</span>
<span class="c1">//fsr:0,±250dps;1,±500dps;2,±1000dps;3,±2000dps</span>
<span class="c1">//返回值:0,设置成功</span>
<span class="c1">//    其他,设置失败</span>
<span class="n">u8</span> <span class="nf">MPU_Set_Gyro_Fsr</span><span class="p">(</span><span class="n">u8</span> <span class="n">fsr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_GYRO_CFG_REG</span><span class="p">,</span><span class="n">fsr</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">);</span><span class="c1">//设置陀螺仪满量程范围</span>
<span class="p">}</span>
<span class="c1">//设置MPU9250加速度传感器满量程范围</span>
<span class="c1">//fsr:0,±2g;1,±4g;2,±8g;3,±16g</span>
<span class="c1">//返回值:0,设置成功</span>
<span class="c1">//    其他,设置失败</span>
<span class="n">u8</span> <span class="nf">MPU_Set_Accel_Fsr</span><span class="p">(</span><span class="n">u8</span> <span class="n">fsr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_ACCEL_CFG_REG</span><span class="p">,</span><span class="n">fsr</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">);</span><span class="c1">//设置加速度传感器满量程范围</span>
<span class="p">}</span>

<span class="c1">//设置MPU9250的数字低通滤波器</span>
<span class="c1">//lpf:数字低通滤波频率(Hz)</span>
<span class="c1">//返回值:0,设置成功</span>
<span class="c1">//    其他,设置失败</span>
<span class="n">u8</span> <span class="nf">MPU_Set_LPF</span><span class="p">(</span><span class="n">u16</span> <span class="n">lpf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">lpf</span><span class="o">&gt;=</span><span class="mi">188</span><span class="p">)</span><span class="n">data</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">lpf</span><span class="o">&gt;=</span><span class="mi">98</span><span class="p">)</span><span class="n">data</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">lpf</span><span class="o">&gt;=</span><span class="mi">42</span><span class="p">)</span><span class="n">data</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">lpf</span><span class="o">&gt;=</span><span class="mi">20</span><span class="p">)</span><span class="n">data</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">lpf</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">)</span><span class="n">data</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
    <span class="k">else</span> <span class="n">data</span><span class="o">=</span><span class="mi">6</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_CFG_REG</span><span class="p">,</span><span class="n">data</span><span class="p">);</span><span class="c1">//设置数字低通滤波器</span>
<span class="p">}</span>

<span class="c1">//设置MPU9250的采样率(假定Fs=1KHz)</span>
<span class="c1">//rate:4~1000(Hz)</span>
<span class="c1">//返回值:0,设置成功</span>
<span class="c1">//    其他,设置失败</span>
<span class="n">u8</span> <span class="nf">MPU_Set_Rate</span><span class="p">(</span><span class="n">u16</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rate</span><span class="o">&gt;</span><span class="mi">1000</span><span class="p">)</span><span class="n">rate</span><span class="o">=</span><span class="mi">1000</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rate</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">)</span><span class="n">rate</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
    <span class="n">data</span><span class="o">=</span><span class="mi">1000</span><span class="o">/</span><span class="n">rate</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">data</span><span class="o">=</span><span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_SAMPLE_RATE_REG</span><span class="p">,</span><span class="n">data</span><span class="p">);</span> <span class="c1">//设置数字低通滤波器</span>
    <span class="k">return</span> <span class="n">MPU_Set_LPF</span><span class="p">(</span><span class="n">rate</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//自动设置LPF为采样率的一半</span>
<span class="p">}</span>

<span class="c1">//得到温度值</span>
<span class="c1">//返回值:温度值(扩大了100倍)</span>
<span class="kt">short</span> <span class="nf">MPU_Get_Temperature</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">short</span> <span class="n">raw</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">temp</span><span class="p">;</span>
    <span class="n">MPU_Read_Len</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_TEMP_OUTH_REG</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
    <span class="n">raw</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">21</span><span class="o">+</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">raw</span><span class="p">)</span><span class="o">/</span><span class="mf">333.87</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">temp</span><span class="o">*</span><span class="mi">100</span><span class="p">;;</span>
<span class="p">}</span>
<span class="c1">//得到陀螺仪值(原始值)</span>
<span class="c1">//gx,gy,gz:陀螺仪x,y,z轴的原始读数(带符号)</span>
<span class="c1">//返回值:0,成功</span>
<span class="c1">//    其他,错误代码</span>
<span class="n">u8</span> <span class="nf">MPU_Get_Gyroscope</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="n">gx</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">gy</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">gz</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">res</span><span class="p">;</span>
    <span class="n">res</span><span class="o">=</span><span class="n">MPU_Read_Len</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_GYRO_XOUTH_REG</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">gx</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="o">*</span><span class="n">gy</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="o">*</span><span class="n">gz</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;;</span>
<span class="p">}</span>
<span class="c1">//得到加速度值(原始值)</span>
<span class="c1">//gx,gy,gz:陀螺仪x,y,z轴的原始读数(带符号)</span>
<span class="c1">//返回值:0,成功</span>
<span class="c1">//    其他,错误代码</span>
<span class="n">u8</span> <span class="nf">MPU_Get_Accelerometer</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="n">ax</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">ay</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">az</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">res</span><span class="p">;</span>
    <span class="n">res</span><span class="o">=</span><span class="n">MPU_Read_Len</span><span class="p">(</span><span class="n">MPU9250_ADDR</span><span class="p">,</span><span class="n">MPU_ACCEL_XOUTH_REG</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">ax</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="o">*</span><span class="n">ay</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="o">*</span><span class="n">az</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;;</span>
<span class="p">}</span>

<span class="c1">//得到磁力计值(原始值)</span>
<span class="c1">//mx,my,mz:磁力计x,y,z轴的原始读数(带符号)</span>
<span class="c1">//返回值:0,成功</span>
<span class="c1">//    其他,错误代码</span>
<span class="n">u8</span> <span class="nf">MPU_Get_Magnetometer</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="n">mx</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">my</span><span class="p">,</span><span class="kt">short</span> <span class="o">*</span><span class="n">mz</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">res</span><span class="p">;</span>
    <span class="n">res</span><span class="o">=</span><span class="n">MPU_Read_Len</span><span class="p">(</span><span class="n">AK8963_ADDR</span><span class="p">,</span><span class="n">MAG_XOUT_L</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">mx</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="o">*</span><span class="n">my</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="o">*</span><span class="n">mz</span><span class="o">=</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">MPU_Write_Byte</span><span class="p">(</span><span class="n">AK8963_ADDR</span><span class="p">,</span><span class="n">MAG_CNTL1</span><span class="p">,</span><span class="mi">0</span><span class="n">X11</span><span class="p">);</span> <span class="c1">//AK8963每次读完以后都需要重新设置为单次测量模式</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;;</span>
<span class="p">}</span>

<span class="c1">//IIC连续写</span>
<span class="c1">//addr:器件地址</span>
<span class="c1">//reg:寄存器地址</span>
<span class="c1">//len:写入长度</span>
<span class="c1">//buf:数据区</span>
<span class="c1">//返回值:0,正常</span>
<span class="c1">//    其他,错误代码</span>
<span class="n">u8</span> <span class="nf">MPU_Write_Len</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">,</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span><span class="n">u8</span> <span class="n">len</span><span class="p">,</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HAL_I2C_Mem_Write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hi2c1</span><span class="p">,</span><span class="n">addr</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">I2C_MEMADD_SIZE_8BIT</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="mi">300</span><span class="p">);</span>
    <span class="cm">/* u8 i;</span>
<span class="cm">     IIC_Start();</span>
<span class="cm">     IIC_Send_Byte((addr&lt;&lt;1)|0); //发送器件地址+写命令</span>
<span class="cm">     if(IIC_Wait_Ack())          //等待应答</span>
<span class="cm">     {</span>
<span class="cm">         IIC_Stop();</span>
<span class="cm">         return 1;</span>
<span class="cm">     }</span>
<span class="cm">     IIC_Send_Byte(reg);         //写寄存器地址</span>
<span class="cm">     IIC_Wait_Ack();             //等待应答</span>
<span class="cm">     for(i=0;i&lt;len;i++)</span>
<span class="cm">     {</span>
<span class="cm">         IIC_Send_Byte(buf[i]);  //发送数据</span>
<span class="cm">         if(IIC_Wait_Ack())      //等待ACK</span>
<span class="cm">         {</span>
<span class="cm">             IIC_Stop();</span>
<span class="cm">             return 1;</span>
<span class="cm">         }</span>
<span class="cm">     }</span>
<span class="cm">     IIC_Stop();*/</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//IIC连续读</span>
<span class="c1">//addr:器件地址</span>
<span class="c1">//reg:要读取的寄存器地址</span>
<span class="c1">//len:要读取的长度</span>
<span class="c1">//buf:读取到的数据存储区</span>
<span class="c1">//返回值:0,正常</span>
<span class="c1">//    其他,错误代码</span>
<span class="n">u8</span> <span class="nf">MPU_Read_Len</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">,</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span><span class="n">u8</span> <span class="n">len</span><span class="p">,</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HAL_I2C_Mem_Read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hi2c1</span><span class="p">,</span> <span class="n">addr</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">I2C_MEMADD_SIZE_8BIT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
    <span class="cm">/*IIC_Start();</span>
<span class="cm">    IIC_Send_Byte((addr&lt;&lt;1)|0); //发送器件地址+写命令</span>
<span class="cm">    if(IIC_Wait_Ack())          //等待应答</span>
<span class="cm">    {</span>
<span class="cm">        IIC_Stop();</span>
<span class="cm">        return 1;</span>
<span class="cm">    }</span>
<span class="cm">    IIC_Send_Byte(reg);         //写寄存器地址</span>
<span class="cm">    IIC_Wait_Ack();             //等待应答</span>
<span class="cm">    IIC_Start();</span>
<span class="cm">    IIC_Send_Byte((addr&lt;&lt;1)|1); //发送器件地址+读命令</span>
<span class="cm">    IIC_Wait_Ack();             //等待应答</span>
<span class="cm">    while(len)</span>
<span class="cm">    {</span>
<span class="cm">        if(len==1)*buf=IIC_Read_Byte(0);//读数据,发送nACK</span>
<span class="cm">        else *buf=IIC_Read_Byte(1);     //读数据,发送ACK</span>
<span class="cm">        len--;</span>
<span class="cm">        buf++;</span>
<span class="cm">    }</span>
<span class="cm">    IIC_Stop();                 //产生一个停止条件*/</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//IIC写一个字节</span>
<span class="c1">//devaddr:器件IIC地址</span>
<span class="c1">//reg:寄存器地址</span>
<span class="c1">//data:数据</span>
<span class="c1">//返回值:0,正常</span>
<span class="c1">//    其他,错误代码</span>
<span class="n">u8</span> <span class="nf">MPU_Write_Byte</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">,</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span><span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HAL_I2C_Mem_Write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hi2c1</span><span class="p">,</span><span class="n">addr</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">I2C_MEMADD_SIZE_8BIT</span><span class="p">,</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">300</span><span class="p">);</span>
<span class="c1">//    IIC_Start();</span>
<span class="c1">////    IIC_Send_Byte((addr&lt;&lt;1)|0); //发送器件地址+写命令</span>
<span class="c1">////    if(IIC_Wait_Ack())          //等待应答</span>
<span class="c1">////    {</span>
<span class="c1">////        IIC_Stop();</span>
<span class="c1">////        return 1;</span>
<span class="c1">////    }</span>
<span class="c1">////    IIC_Send_Byte(reg);         //写寄存器地址</span>
<span class="c1">////    IIC_Wait_Ack();             //等待应答</span>
<span class="c1">////    IIC_Send_Byte(data);        //发送数据</span>
<span class="c1">////    if(IIC_Wait_Ack())          //等待ACK</span>
<span class="c1">////    {</span>
<span class="c1">////        IIC_Stop();</span>
<span class="c1">////        return 1;</span>
<span class="c1">////    }</span>
<span class="c1">////    IIC_Stop();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//IIC读一个字节</span>
<span class="c1">//reg:寄存器地址</span>
<span class="c1">//返回值:读到的数据</span>
<span class="n">u8</span> <span class="nf">MPU_Read_Byte</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">,</span><span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">res</span><span class="p">;</span>
    <span class="n">HAL_I2C_Mem_Read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hi2c1</span><span class="p">,</span> <span class="n">addr</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">I2C_MEMADD_SIZE_8BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
<span class="c1">//    u8 res;</span>
<span class="c1">//    IIC_Start();</span>
<span class="c1">//    IIC_Send_Byte((addr&lt;&lt;1)|0); //发送器件地址+写命令</span>
<span class="c1">//    IIC_Wait_Ack();             //等待应答</span>
<span class="c1">//    IIC_Send_Byte(reg);         //写寄存器地址</span>
<span class="c1">//    IIC_Wait_Ack();             //等待应答</span>
<span class="c1">//    IIC_Start();</span>
<span class="c1">//    IIC_Send_Byte((addr&lt;&lt;1)|1); //发送器件地址+读命令</span>
<span class="c1">//    IIC_Wait_Ack();             //等待应答</span>
<span class="c1">//    res=IIC_Read_Byte(0);     //读数据,发送nACK</span>
<span class="c1">//    IIC_Stop();                 //产生一个停止条件</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../04_03_blueth/" title="蓝牙控制" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                蓝牙控制
              </span>
            </div>
          </a>
        
        
          <a href="../05_custom_serial/" title="串口通讯" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                串口通讯
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a href="https://www.czxy.com/">传智专修学院</a> 版权所有 2006 - 2020 江苏传智播客教育科技股份有限公司  学校地址：江苏省宿迁市沭阳县北京南路6号  邮编：223600   <a href="http://www.beian.miit.gov.cn/">苏ICP备16007882号-4</a>
          </div>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
            
          
          
        
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
        <script src="../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
        <script src="../js/baidu-tongji.js"></script>
      
    
  </body>
</html>