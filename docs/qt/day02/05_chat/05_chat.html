



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="传智专修学院 人工智能和机器人实验室 Qt编程">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>五、Qt综合项目-局域网聊天室 - 黑马机器人—Qt编程</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#qt-" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="黑马机器人—Qt编程" aria-label="黑马机器人—Qt编程" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              黑马机器人—Qt编程
            </span>
            <span class="md-header-nav__topic">
              
                五、Qt综合项目-局域网聊天室
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="黑马机器人—Qt编程" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    黑马机器人—Qt编程
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      day01-Qt基础
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        day01-Qt基础
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../day01/01_intro/" title="一、Qt简介" class="md-nav__link">
      一、Qt简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../day01/02_env/" title="二、Qt环境搭建" class="md-nav__link">
      二、Qt环境搭建
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../day01/03_window/" title="三、Qt窗口" class="md-nav__link">
      三、Qt窗口
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../day01/04_object_tree/" title="四、Qt对象树模型" class="md-nav__link">
      四、Qt对象树模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../day01/05_signal_slot/" title="五、信号和槽" class="md-nav__link">
      五、信号和槽
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../day01/06_resources/" title="六、资源文件" class="md-nav__link">
      六、资源文件
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      day02-Qt高级
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        day02-Qt高级
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01_widget_layout/" title="一、控件和布局" class="md-nav__link">
      一、控件和布局
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02_event_paint/" title="二、事件机制和绘制" class="md-nav__link">
      二、事件机制和绘制
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03_clock/" title="三、黑马时钟" class="md-nav__link">
      三、黑马时钟
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../04_socket/" title="四、Socket通信" class="md-nav__link">
      四、Socket通信
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        五、Qt综合项目-局域网聊天室
      </label>
    
    <a href="./" title="五、Qt综合项目-局域网聊天室" class="md-nav__link md-nav__link--active">
      五、Qt综合项目-局域网聊天室
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1.项目介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2. 主界面
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3. 聊天界面
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1.项目介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2. 主界面
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3. 聊天界面
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="qt-">五、Qt综合项目-局域网聊天室<a class="headerlink" href="#qt-" title="Permanent link">#</a></h1>
<h2 id="1">1.项目介绍<a class="headerlink" href="#1" title="Permanent link">#</a></h2>
<blockquote>
<p>最后我们可以使用Qt做一个局域网聊天室</p>
</blockquote>
<p>好友列表页面如下：</p>
<p><img alt="" src="../img/7.png" /></p>
<blockquote>
<p>首页展示好友列表，点击好友进入聊天界面</p>
</blockquote>
<p>聊天界面如下：</p>
<p><img alt="" src="../img/8.png" /></p>
<blockquote>
<p>聊天界面可以显示展示进入局域网好友列表</p>
<p>有新用户进入，提示新用户进入</p>
<p>用户离开，提示用户离开</p>
<p>发送消息可以发送给所有在线的用户</p>
</blockquote>
<h2 id="2">2. 主界面<a class="headerlink" href="#2" title="Permanent link">#</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;MainWindow.h&quot;</span><span class="cp"></span>

<span class="n">MainWindow</span><span class="o">::</span><span class="n">MainWindow</span><span class="p">(</span><span class="n">QWidget</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span> <span class="o">:</span> <span class="n">QMainWindow</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//设置大小</span>
    <span class="n">setFixedSize</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">700</span><span class="p">);</span>
    <span class="c1">//设置标题</span>
    <span class="n">setWindowTitle</span><span class="p">(</span><span class="s">&quot;QQ&quot;</span><span class="p">);</span>
    <span class="c1">//设置图标</span>
    <span class="n">setWindowIcon</span><span class="p">(</span><span class="n">QIcon</span><span class="p">(</span><span class="s">&quot;:/images/qq.png&quot;</span><span class="p">));</span>
    <span class="c1">//初始化界面</span>
    <span class="n">initUI</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MainWindow</span><span class="o">::~</span><span class="n">MainWindow</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>

<span class="c1">//初始化界面</span>
<span class="kt">void</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">initUI</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="o">*</span><span class="n">tb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolBox</span><span class="p">;</span>
    <span class="k">auto</span> <span class="o">*</span><span class="n">gb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QGroupBox</span><span class="p">;</span>
    <span class="k">auto</span> <span class="o">*</span><span class="n">vl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QVBoxLayout</span><span class="p">;</span>
    <span class="c1">//添加条目</span>
    <span class="n">tb</span><span class="o">-&gt;</span><span class="n">addItem</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="s">&quot;联系人&quot;</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">setLayout</span><span class="p">(</span><span class="n">vl</span><span class="p">);</span>
    <span class="c1">//添加中心控件</span>
    <span class="n">setCentralWidget</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
    <span class="c1">//创建联系人条目</span>
    <span class="n">createContacts</span><span class="p">(</span><span class="n">vl</span><span class="p">);</span>
    <span class="c1">//每个窗口是否显示</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">btns</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">isShows</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//处理每一个按钮的事件</span>
    <span class="n">contactsClick</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">//创建联系人条目</span>
<span class="kt">void</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">createContacts</span><span class="p">(</span><span class="n">QVBoxLayout</span> <span class="o">*</span><span class="k">const</span> <span class="o">&amp;</span><span class="n">layout</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">QList</span><span class="o">&lt;</span><span class="n">QString</span><span class="o">&gt;</span> <span class="n">nameList</span><span class="p">{</span><span class="s">&quot;Maker&quot;</span><span class="p">,</span> <span class="s">&quot;水票奇缘&quot;</span><span class="p">,</span> <span class="s">&quot;忆梦如澜&quot;</span><span class="p">,</span> <span class="s">&quot;北京出版人&quot;</span><span class="p">,</span> <span class="s">&quot;Cherry&quot;</span><span class="p">,</span> <span class="s">&quot;淡然&quot;</span><span class="p">,</span> <span class="s">&quot;娇娇girl&quot;</span><span class="p">,</span> <span class="s">&quot;落水无痕&quot;</span><span class="p">,</span>
                            <span class="s">&quot;青墨暖暖&quot;</span><span class="p">};</span>
    <span class="n">QStringList</span> <span class="n">iconList</span><span class="p">{</span><span class="s">&quot;qt&quot;</span><span class="p">,</span> <span class="s">&quot;spqy&quot;</span><span class="p">,</span> <span class="s">&quot;ymrl&quot;</span><span class="p">,</span> <span class="s">&quot;qq&quot;</span><span class="p">,</span> <span class="s">&quot;Cherry&quot;</span><span class="p">,</span> <span class="s">&quot;dr&quot;</span><span class="p">,</span> <span class="s">&quot;jj&quot;</span><span class="p">,</span> <span class="s">&quot;lswh&quot;</span><span class="p">,</span> <span class="s">&quot;qmnn&quot;</span><span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nameList</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//创建按钮</span>
        <span class="k">auto</span> <span class="o">*</span><span class="n">btn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolButton</span><span class="p">();</span>
        <span class="c1">//添加文字</span>
        <span class="n">btn</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="n">nameList</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="c1">//添加图片</span>
        <span class="k">auto</span> <span class="o">*</span><span class="n">icon</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QPixmap</span><span class="p">(</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;:/images/%1.png&quot;</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">iconList</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
        <span class="n">btn</span><span class="o">-&gt;</span><span class="n">setIcon</span><span class="p">(</span><span class="o">*</span><span class="n">icon</span><span class="p">);</span>

        <span class="c1">//设置样式</span>
        <span class="n">btn</span><span class="o">-&gt;</span><span class="n">setToolButtonStyle</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">ToolButtonTextBesideIcon</span><span class="p">);</span>
        <span class="c1">//设置按钮大小</span>
        <span class="n">btn</span><span class="o">-&gt;</span><span class="n">resize</span><span class="p">(</span><span class="mi">210</span><span class="p">,</span> <span class="mi">70</span><span class="p">);</span>
        <span class="c1">//按钮图片大小</span>
        <span class="n">btn</span><span class="o">-&gt;</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">icon</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>
        <span class="c1">//设置透明度</span>
        <span class="n">btn</span><span class="o">-&gt;</span><span class="n">setAutoRaise</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="c1">//添加到布局中</span>
        <span class="n">layout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
        <span class="c1">//添加到按钮的列表中</span>
        <span class="n">btns</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//处理每一个按钮的点击事件</span>
<span class="kt">void</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">contactsClick</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">btns</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">QToolButton</span> <span class="o">*</span><span class="n">btn</span> <span class="o">=</span> <span class="n">btns</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">connect</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QToolButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isShows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
                <span class="c1">//创建会话窗口</span>
                <span class="k">auto</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConversationWindow</span><span class="p">(</span><span class="n">btn</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">());</span>
                <span class="c1">//设置标题和图标</span>
                <span class="n">w</span><span class="o">-&gt;</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">btn</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">());</span>
                <span class="n">w</span><span class="o">-&gt;</span><span class="n">setWindowIcon</span><span class="p">(</span><span class="n">btn</span><span class="o">-&gt;</span><span class="n">icon</span><span class="p">());</span>
                <span class="c1">//设置显示属性</span>
                <span class="n">w</span><span class="o">-&gt;</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">WA_DeleteOnClose</span><span class="p">);</span>
                <span class="n">w</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">();</span>
                <span class="c1">//改变显示标记</span>
                <span class="n">isShows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="c1">//关闭的回调</span>
                <span class="n">connect</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ConversationWindow</span><span class="o">::</span><span class="n">conversationClose</span><span class="p">,[</span><span class="o">=</span><span class="p">](){</span>
                    <span class="n">isShows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>

<h2 id="3">3. 聊天界面<a class="headerlink" href="#3" title="Permanent link">#</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;ConversationWindow.h&quot;</span><span class="cp"></span>

<span class="n">ConversationWindow</span><span class="o">::</span><span class="n">ConversationWindow</span><span class="p">(</span><span class="n">QString</span> <span class="n">name</span><span class="p">,</span> <span class="n">QWidget</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span> <span class="o">:</span> <span class="n">QMainWindow</span><span class="p">(</span><span class="n">parent</span><span class="p">),</span> <span class="n">name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//设置界面大小</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">resize</span><span class="p">(</span><span class="mi">740</span><span class="p">,</span> <span class="mi">450</span><span class="p">);</span>
    <span class="c1">//初始化界面</span>
    <span class="n">initUI</span><span class="p">();</span>
    <span class="c1">//按钮的点击事件</span>
    <span class="n">btnsClick</span><span class="p">();</span>
    <span class="c1">//信息相关的操作</span>
    <span class="n">socketOperator</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">ConversationWindow</span><span class="o">::~</span><span class="n">ConversationWindow</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>

<span class="c1">//初始化界面</span>
<span class="kt">void</span> <span class="n">ConversationWindow</span><span class="o">::</span><span class="n">initUI</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//整体竖直布局</span>
    <span class="n">QVBoxLayout</span> <span class="o">*</span><span class="n">wholeLayout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QVBoxLayout</span><span class="p">;</span>
    <span class="c1">//左侧竖直布局</span>
    <span class="n">QVBoxLayout</span> <span class="o">*</span><span class="n">leftLayout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QVBoxLayout</span><span class="p">;</span>
    <span class="c1">//右侧TableWidget</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QTableWidget</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">tw</span><span class="o">-&gt;</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">180</span><span class="p">);</span>

    <span class="n">tw</span><span class="o">-&gt;</span><span class="n">setHorizontalHeaderLabels</span><span class="p">(</span><span class="n">QStringList</span><span class="p">{</span><span class="s">&quot;用户名&quot;</span><span class="p">});</span>

    <span class="c1">//上部布局</span>
    <span class="n">QHBoxLayout</span> <span class="o">*</span><span class="n">upLayout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QHBoxLayout</span><span class="p">;</span>
    <span class="c1">//下部布局</span>
    <span class="n">QHBoxLayout</span> <span class="o">*</span><span class="n">downLayout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QHBoxLayout</span><span class="p">;</span>
    <span class="c1">//发送按钮</span>
    <span class="n">sendBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QPushButton</span><span class="p">;</span>
    <span class="n">sendBtn</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="s">&quot;发送&quot;</span><span class="p">);</span>
    <span class="c1">//在线人数</span>
    <span class="n">label</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QLabel</span><span class="p">;</span>
    <span class="n">label</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="s">&quot;在线人数:1&quot;</span><span class="p">);</span>
    <span class="c1">//退出按钮</span>
    <span class="n">exitBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QPushButton</span><span class="p">;</span>
    <span class="n">exitBtn</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="s">&quot;退出&quot;</span><span class="p">);</span>


    <span class="c1">//左侧</span>
    <span class="c1">//1.消息显示框</span>
    <span class="n">msgEdit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QTextEdit</span><span class="p">;</span>
    <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">setReadOnly</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="c1">//2.水平布局(字体等)</span>
    <span class="n">QHBoxLayout</span> <span class="o">*</span><span class="n">iconLayout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QHBoxLayout</span><span class="p">;</span>
    <span class="c1">//3.发送消息输入框</span>
    <span class="n">sendEdit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QTextEdit</span><span class="p">;</span>

    <span class="c1">//图标</span>
    <span class="c1">//1.宋体</span>
    <span class="n">fontBox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QFontComboBox</span><span class="p">;</span>
    <span class="c1">//2.字体大小</span>
    <span class="n">fontSizeBox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QComboBox</span><span class="p">;</span>
    <span class="c1">//3.字体加粗</span>
    <span class="n">blod</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolButton</span><span class="p">;</span>
    <span class="c1">//4.斜体</span>
    <span class="n">italic</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolButton</span><span class="p">;</span>
    <span class="c1">//5.下划线</span>
    <span class="n">underLine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolButton</span><span class="p">;</span>
    <span class="c1">//6.更改字体颜色</span>
    <span class="n">fontColor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolButton</span><span class="p">;</span>
    <span class="c1">//7.保存聊天记录</span>
    <span class="n">saveConversation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolButton</span><span class="p">;</span>
    <span class="c1">//8.清空聊天记录</span>
    <span class="n">clearConversation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolButton</span><span class="p">;</span>

    <span class="c1">//设置加粗、斜体和下划线可以选中</span>
    <span class="n">blod</span><span class="o">-&gt;</span><span class="n">setCheckable</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">italic</span><span class="o">-&gt;</span><span class="n">setCheckable</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">underLine</span><span class="o">-&gt;</span><span class="n">setCheckable</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

    <span class="c1">//添加图标布局</span>
    <span class="n">iconLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">fontBox</span><span class="p">);</span>
    <span class="n">iconLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">fontSizeBox</span><span class="p">);</span>
    <span class="n">iconLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">blod</span><span class="p">);</span>
    <span class="n">iconLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">italic</span><span class="p">);</span>
    <span class="n">iconLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">underLine</span><span class="p">);</span>
    <span class="n">iconLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">fontColor</span><span class="p">);</span>
    <span class="n">iconLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">saveConversation</span><span class="p">);</span>
    <span class="n">iconLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">clearConversation</span><span class="p">);</span>

    <span class="c1">//添加左侧</span>
    <span class="n">leftLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">msgEdit</span><span class="p">);</span>
    <span class="n">leftLayout</span><span class="o">-&gt;</span><span class="n">addLayout</span><span class="p">(</span><span class="n">iconLayout</span><span class="p">);</span>
    <span class="n">leftLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">sendEdit</span><span class="p">);</span>

    <span class="c1">//上部布局</span>
    <span class="n">upLayout</span><span class="o">-&gt;</span><span class="n">addLayout</span><span class="p">(</span><span class="n">leftLayout</span><span class="p">);</span>
    <span class="n">upLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">tw</span><span class="p">);</span>
    <span class="c1">//下部布局</span>
    <span class="n">downLayout</span><span class="o">-&gt;</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">downLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">sendBtn</span><span class="p">);</span>
    <span class="n">downLayout</span><span class="o">-&gt;</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">downLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">);</span>
    <span class="n">downLayout</span><span class="o">-&gt;</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">downLayout</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">exitBtn</span><span class="p">);</span>
    <span class="n">downLayout</span><span class="o">-&gt;</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">//整体布局添加</span>
    <span class="n">wholeLayout</span><span class="o">-&gt;</span><span class="n">addLayout</span><span class="p">(</span><span class="n">upLayout</span><span class="p">);</span>
    <span class="n">wholeLayout</span><span class="o">-&gt;</span><span class="n">addLayout</span><span class="p">(</span><span class="n">downLayout</span><span class="p">);</span>

    <span class="c1">//设置中心控件</span>
    <span class="n">QWidget</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QWidget</span><span class="p">;</span>
    <span class="n">w</span><span class="o">-&gt;</span><span class="n">setLayout</span><span class="p">(</span><span class="n">wholeLayout</span><span class="p">);</span>
    <span class="n">setCentralWidget</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>


    <span class="c1">//处理细节</span>
    <span class="c1">//1.字体大小</span>
    <span class="n">fontSizeBox</span><span class="o">-&gt;</span><span class="n">addItem</span><span class="p">(</span><span class="s">&quot;12&quot;</span><span class="p">);</span>
    <span class="n">fontSizeBox</span><span class="o">-&gt;</span><span class="n">addItem</span><span class="p">(</span><span class="s">&quot;13&quot;</span><span class="p">);</span>
    <span class="n">fontSizeBox</span><span class="o">-&gt;</span><span class="n">addItem</span><span class="p">(</span><span class="s">&quot;14&quot;</span><span class="p">);</span>
    <span class="n">fontSizeBox</span><span class="o">-&gt;</span><span class="n">addItem</span><span class="p">(</span><span class="s">&quot;15&quot;</span><span class="p">);</span>
    <span class="c1">//2.图标</span>
    <span class="n">blod</span><span class="o">-&gt;</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">QSize</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">));</span>
    <span class="n">italic</span><span class="o">-&gt;</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">QSize</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">));</span>
    <span class="n">underLine</span><span class="o">-&gt;</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">QSize</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">));</span>
    <span class="n">fontColor</span><span class="o">-&gt;</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">QSize</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">));</span>
    <span class="n">saveConversation</span><span class="o">-&gt;</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">QSize</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">));</span>
    <span class="n">clearConversation</span><span class="o">-&gt;</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">QSize</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">));</span>
    <span class="c1">//加粗</span>
    <span class="n">blod</span><span class="o">-&gt;</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QPixmap</span><span class="p">(</span><span class="s">&quot;:/images/bold.png&quot;</span><span class="p">));</span>
    <span class="n">italic</span><span class="o">-&gt;</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QPixmap</span><span class="p">(</span><span class="s">&quot;:/images/italic.png&quot;</span><span class="p">));</span>
    <span class="n">underLine</span><span class="o">-&gt;</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QPixmap</span><span class="p">(</span><span class="s">&quot;:/images/under.png&quot;</span><span class="p">));</span>
    <span class="n">fontColor</span><span class="o">-&gt;</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QPixmap</span><span class="p">(</span><span class="s">&quot;:/images/color.png&quot;</span><span class="p">));</span>
    <span class="n">saveConversation</span><span class="o">-&gt;</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QPixmap</span><span class="p">(</span><span class="s">&quot;:/images/save.png&quot;</span><span class="p">));</span>
    <span class="n">clearConversation</span><span class="o">-&gt;</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QPixmap</span><span class="p">(</span><span class="s">&quot;:/images/clear.png&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">//按钮信号和槽函数</span>
<span class="kt">void</span> <span class="n">ConversationWindow</span><span class="o">::</span><span class="n">btnsClick</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//字体设置</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">fontBox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QFontComboBox</span><span class="o">::</span><span class="n">currentFontChanged</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="k">const</span> <span class="n">QFont</span> <span class="o">&amp;</span><span class="n">font</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="c1">//字体大小设置</span>
    <span class="kt">void</span> <span class="p">(</span><span class="n">QComboBox</span><span class="o">::*</span><span class="n">currentIndexChanged</span><span class="p">)(</span><span class="k">const</span> <span class="n">QString</span> <span class="o">&amp;</span><span class="n">text</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">QComboBox</span><span class="o">::</span><span class="n">currentIndexChanged</span><span class="p">;</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">fontSizeBox</span><span class="p">,</span> <span class="n">currentIndexChanged</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="k">const</span> <span class="n">QString</span> <span class="o">&amp;</span><span class="n">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">setFontPointSize</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="n">toDouble</span><span class="p">());</span>
    <span class="p">});</span>
    <span class="c1">//字体加粗</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">blod</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QToolButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="kt">bool</span> <span class="n">checked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">setFontWeight</span><span class="p">(</span><span class="n">QFont</span><span class="o">::</span><span class="n">Bold</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">setFontWeight</span><span class="p">(</span><span class="n">QFont</span><span class="o">::</span><span class="n">Normal</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="c1">//斜体</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">italic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QToolButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="kt">bool</span> <span class="n">checked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">setFontItalic</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">setFontItalic</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="c1">//下划线</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">underLine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QToolButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="kt">bool</span> <span class="n">checked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">setFontUnderline</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">setFontUnderline</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="c1">//选择颜色</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">fontColor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QPushButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
        <span class="n">QColor</span> <span class="n">color</span> <span class="o">=</span> <span class="n">QColorDialog</span><span class="o">::</span><span class="n">getColor</span><span class="p">();</span>
        <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">setTextColor</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="c1">//保存聊天记录</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">saveConversation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QToolButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
        <span class="c1">//选择保存的文件名</span>
        <span class="n">QString</span> <span class="n">path</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">::</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">&quot;请选择保存的文件名&quot;</span><span class="p">,</span> <span class="s">&quot;/home/wt/Downloads&quot;</span><span class="p">,</span> <span class="s">&quot;TXT(*.txt*)&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="c1">//创建文件</span>
        <span class="n">QFile</span> <span class="nf">f</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
        <span class="n">f</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">QIODevice</span><span class="o">::</span><span class="n">WriteOnly</span><span class="p">);</span>
        <span class="n">QString</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">toPlainText</span><span class="p">();</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">toUtf8</span><span class="p">().</span><span class="n">data</span><span class="p">());</span>
        <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="c1">//清空聊天记录</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">clearConversation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QToolButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
       <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">//信息相关的操作</span>
<span class="kt">void</span> <span class="n">ConversationWindow</span><span class="o">::</span><span class="n">socketOperator</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QUdpSocket</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">socket</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">(</span><span class="mi">6666</span><span class="p">,</span> <span class="n">QUdpSocket</span><span class="o">::</span><span class="n">ShareAddress</span> <span class="o">|</span> <span class="n">QUdpSocket</span><span class="o">::</span><span class="n">ReuseAddressHint</span><span class="p">);</span>

    <span class="c1">//发送消息</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">sendBtn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QPushButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
        <span class="n">sendMsg</span><span class="p">(</span><span class="n">MSGTYPE</span><span class="o">::</span><span class="n">MSG</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="c1">//接收消息</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QUdpSocket</span><span class="o">::</span><span class="n">readyRead</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
        <span class="n">receiveMsg</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="c1">//上线通知</span>
    <span class="n">sendMsg</span><span class="p">(</span><span class="n">MSGTYPE</span><span class="o">::</span><span class="n">ENTER</span><span class="p">);</span>
    <span class="c1">//下线通知</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">exitBtn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">QPushButton</span><span class="o">::</span><span class="n">clicked</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
        <span class="c1">//退出窗口</span>
        <span class="n">close</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">//发送消息</span>
<span class="kt">void</span> <span class="n">ConversationWindow</span><span class="o">::</span><span class="n">sendMsg</span><span class="p">(</span><span class="n">MSGTYPE</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//要发送的消息</span>
    <span class="n">QByteArray</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">QDataStream</span> <span class="nf">out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">QIODevice</span><span class="o">::</span><span class="n">WriteOnly</span><span class="p">);</span>
    <span class="c1">//先写入消息类型和用户名</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="n">name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">MSGTYPE</span><span class="o">::</span><span class="n">MSG</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">QString</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">toPlainText</span><span class="p">();</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//发送消息</span>
    <span class="n">socket</span><span class="o">-&gt;</span><span class="n">writeDatagram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">QHostAddress</span><span class="o">::</span><span class="n">Broadcast</span><span class="p">,</span> <span class="mi">6666</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//接收消息</span>
<span class="kt">void</span> <span class="n">ConversationWindow</span><span class="o">::</span><span class="n">receiveMsg</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;接收到消息:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">QByteArray</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">pendingDatagramSize</span><span class="p">());</span>
    <span class="n">socket</span><span class="o">-&gt;</span><span class="n">readDatagram</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
    <span class="n">QDataStream</span> <span class="nf">ds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">QIODevice</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">);</span>
    <span class="c1">//读取消息类型</span>
    <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">ds</span> <span class="o">&gt;&gt;</span> <span class="n">type</span><span class="p">;</span>
    <span class="c1">//用户名或者信息</span>
    <span class="n">QString</span> <span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">;</span>
    <span class="n">ds</span> <span class="o">&gt;&gt;</span> <span class="n">name</span><span class="p">;</span>
    <span class="c1">//消息时间</span>
    <span class="n">QString</span> <span class="n">time</span> <span class="o">=</span> <span class="n">QDateTime</span><span class="p">().</span><span class="n">currentDateTime</span><span class="p">().</span><span class="n">toString</span><span class="p">(</span><span class="s">&quot;yyyy-MM-dd hh:mm:ss&quot;</span><span class="p">);</span>
    <span class="c1">//判断消息类型</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">MSGTYPE</span><span class="o">::</span><span class="nl">MSG</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">&gt;&gt;</span> <span class="n">msg</span><span class="p">;</span>
            <span class="n">normalMsg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">MSGTYPE</span><span class="o">::</span><span class="nl">ENTER</span><span class="p">:</span>
            <span class="n">enterMsg</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">MSGTYPE</span><span class="o">::</span><span class="nl">EXIT</span><span class="p">:</span>
            <span class="n">exitMsg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//普通消息</span>
<span class="kt">void</span> <span class="n">ConversationWindow</span><span class="o">::</span><span class="n">normalMsg</span><span class="p">(</span><span class="n">QString</span> <span class="n">name</span><span class="p">,</span> <span class="n">QString</span> <span class="n">msg</span><span class="p">,</span> <span class="n">QString</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//设置颜色</span>
    <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">setTextColor</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">blue</span><span class="p">);</span>
    <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;[%1]%2&quot;</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">time</span><span class="p">));</span>
    <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="c1">//清空输入框</span>
    <span class="n">sendEdit</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">//进入消息</span>
<span class="kt">void</span> <span class="n">ConversationWindow</span><span class="o">::</span><span class="n">enterMsg</span><span class="p">(</span><span class="n">QString</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//是否有这个人</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">findItems</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Qt</span><span class="o">::</span><span class="n">MatchExactly</span><span class="p">).</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">//消息显示</span>
        <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">setTextColor</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">green</span><span class="p">);</span>
        <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;%1 在线&quot;</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
        <span class="c1">//列表显示</span>
        <span class="n">QTableWidgetItem</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
        <span class="n">tw</span><span class="o">-&gt;</span><span class="n">insertRow</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">tw</span><span class="o">-&gt;</span><span class="n">setItem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="p">);</span>

        <span class="c1">//更新在线人数</span>
        <span class="n">label</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;在线人数:%1&quot;</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">rowCount</span><span class="p">()));</span>

        <span class="c1">//发送自己的上线信息给别人</span>
        <span class="n">sendMsg</span><span class="p">(</span><span class="n">MSGTYPE</span><span class="o">::</span><span class="n">ENTER</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//退出消息</span>
<span class="kt">void</span> <span class="n">ConversationWindow</span><span class="o">::</span><span class="n">exitMsg</span><span class="p">(</span><span class="n">QString</span> <span class="n">name</span><span class="p">,</span> <span class="n">QString</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//是否有这个人</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">findItems</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Qt</span><span class="o">::</span><span class="n">MatchExactly</span><span class="p">).</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">//消息显示</span>
        <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">setTextColor</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">green</span><span class="p">);</span>
        <span class="n">msgEdit</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;%1 于%2 离开&quot;</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">time</span><span class="p">));</span>
        <span class="c1">//列表显示</span>
        <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">tw</span><span class="o">-&gt;</span><span class="n">findItems</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Qt</span><span class="o">::</span><span class="n">MatchExactly</span><span class="p">).</span><span class="n">first</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">row</span><span class="p">();</span>
        <span class="n">tw</span><span class="o">-&gt;</span><span class="n">removeRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>

        <span class="c1">//更新在线人数</span>
        <span class="n">label</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;在线人数:%1&quot;</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">rowCount</span><span class="p">()));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//关闭事件</span>
<span class="kt">void</span> <span class="n">ConversationWindow</span><span class="o">::</span><span class="n">closeEvent</span><span class="p">(</span><span class="n">QCloseEvent</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//退出</span>
    <span class="n">sendMsg</span><span class="p">(</span><span class="n">MSGTYPE</span><span class="o">::</span><span class="n">EXIT</span><span class="p">);</span>
    <span class="n">emit</span> <span class="nf">conversationClose</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../04_socket/" title="四、Socket通信" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                四、Socket通信
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a href="https://www.czxy.com/">传智专修学院</a> 版权所有 2006 - 2020 江苏传智播客教育科技股份有限公司  学校地址：江苏省宿迁市沭阳县北京南路6号  邮编：223600   <a href="http://www.beian.miit.gov.cn/">苏ICP备16007882号-4</a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
        
        
          
          <script src="../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
            
          
          
        
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
        <script src="../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
        <script src="../../js/baidu-tongji.js"></script>
      
    
  </body>
</html>